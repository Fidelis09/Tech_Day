<!-- templates/agendamentos.html -->
<div class="agendamentos-fullscreen">
  <!-- CALEND√ÅRIO -->
  <div class="calendario-container">
    <div id="calendar"></div>
  </div>

  <!-- LISTA DE EVENTOS DO DIA -->
  <div class="lista-eventos">
    <h3>Eventos do Dia</h3>
    <div id="eventosDia">
      <p class="no-data">Selecione um dia no calend√°rio.</p>
    </div>
  </div>

  <!-- MODAL DETALHES -->
  <div id="modalEvento" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button id="fecharModal" class="close">&times;</button>
      <h3 id="modalTitulo"></h3>
      <p><strong>Data:</strong> <span id="modalData"></span> <strong>Hora:</strong> <span id="modalHora"></span></p>
      <p><strong>Cliente:</strong> <span id="modalCliente"></span></p>
      <p><strong>Telefone:</strong> <span id="modalTelefone"></span></p>
      <p><strong>Endere√ßo:</strong> <span id="modalEndereco"></span></p>
      <p><strong>Monitor atual:</strong> <span id="modalMonitor"></span></p>
      <p><strong>Brinquedos:</strong> <span id="modalBrinquedos"></span></p>
      <p><strong>Valor Total:</strong> R$ <span id="modalValor"></span></p>

      <!-- NOVO BLOCO: alterar monitor -->
      <label><strong>Alterar Monitor:</strong>
        <select id="selectMonitor" style="width:100%; margin-top:5px; padding:6px; border-radius:6px; border:1px solid #ccc;"></select>
      </label>
      <button id="btnSalvarAlteracao" class="btn" style="background:#007bff; margin-top:10px;">üíæ Salvar Altera√ß√µes</button>

      <!-- BOT√ïES DE A√á√ÉO -->
      <div class="acoes-modal">
        <button id="btnFinalizar" class="btn btn-finalizar">‚úÖ Finalizar</button>
        <button id="btnExcluir" class="btn btn-excluir">üóëÔ∏è Excluir</button>
      </div>
    </div>
  </div>
</div>

<!-- FULLCALENDAR -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<style>
/* üìÖ LAYOUT PRINCIPAL */
.agendamentos-fullscreen {
  width: 100%;
  height: calc(100vh - 120px);
  margin: 0;
  padding: 0;
  display: flex;
  background: #fff;
  gap: 0;
}

/* CALEND√ÅRIO */
.calendario-container {
  flex: 3;
  padding: 25px;
  box-sizing: border-box;
  background: #fff;
}
#calendar {
  height: 100%;
  width: 100%;
  border-radius: 10px;
}

/* LISTA DE EVENTOS DO DIA */
.lista-eventos {
  flex: 1.2;
  background: #f8faff;
  border-left: 2px solid #dbe9ff;
  padding: 18px;
  box-sizing: border-box;
  overflow-y: auto;
}
.lista-eventos h3 {
  color: #1E90FF;
  margin-bottom: 15px;
  font-size: 1.1rem;
}
.evento-item {
  background: #fff;
  border: 1px solid #cfe0ff;
  border-radius: 8px;
  padding: 8px 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: 0.2s;
  font-size: 0.9rem;
}
.evento-item:hover {
  background: #eef5ff;
}
.no-data {
  color: #999;
  font-style: italic;
  font-size: 0.9rem;
}

/* MODAL */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal[aria-hidden="false"] {
  display: flex;
}
.modal-content {
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  width: 90%;
  max-width: 520px;
  position: relative;
}
.close {
  position: absolute;
  right: 15px;
  top: 10px;
  background: none;
  border: none;
  font-size: 1.4rem;
  cursor: pointer;
}

/* BOT√ïES DO MODAL */
.acoes-modal {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}
.btn {
  display: inline-block;
  color: white;
  padding: 10px 18px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
}
.btn-finalizar {
  background: #28a745;
}
.btn-finalizar:hover {
  background: #1e7e34;
}
.btn-excluir {
  background: #dc3545;
}
.btn-excluir:hover {
  background: #a71d2a;
}

/* RESPONSIVO */
@media (max-width: 1024px) {
  .agendamentos-fullscreen {
    flex-direction: column;
  }
  .calendario-container {
    flex: none;
    height: 60vh;
  }
  .lista-eventos {
    flex: none;
    height: 40vh;
    border-left: none;
    border-top: 2px solid #dbe9ff;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const eventosDiaContainer = document.getElementById('eventosDia');

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'pt-br',
    height: '100%',
    expandRows: true,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    events: '/api/agendamentos',
    eventColor: '#ffb84d',
    eventDisplay: 'block',

    eventClick: function(info) {
      abrirModal(info.event.id);
    },

    dateClick: function(info) {
      carregarEventosDoDia(info.dateStr);
    },

    datesSet: function() {
      const hoje = new Date();
      const dataHoje = hoje.toISOString().split('T')[0];
      carregarEventosDoDia(dataHoje);
    }
  });

  calendar.render();

  // MODAL - FECHAR
  document.getElementById('fecharModal').addEventListener('click', () => {
    document.getElementById('modalEvento').setAttribute('aria-hidden', 'true');
  });
  window.addEventListener('click', e => {
    const modal = document.getElementById('modalEvento');
    if (e.target === modal) modal.setAttribute('aria-hidden', 'true');
  });

  // üîπ Fun√ß√£o para carregar eventos do dia selecionado
  function carregarEventosDoDia(dataSelecionada) {
    fetch('/api/agendamentos')
      .then(res => res.json())
      .then(eventos => {
        const eventosDia = eventos.filter(e => e.start.startsWith(dataSelecionada));
        eventosDiaContainer.innerHTML = eventosDia.length
          ? eventosDia.map(ev => `
              <div class="evento-item" onclick="abrirModal('${ev.id}')">
                <strong>${ev.title}</strong><br>
                ${ev.extendedProps.hora_festa || '-'} ‚Äî R$ ${ev.extendedProps.valor_total.toFixed(2)}
              </div>
            `).join('')
          : '<p class="no-data">Nenhum evento neste dia.</p>';
      });
  }

  const hoje = new Date();
  const dataHoje = hoje.toISOString().split('T')[0];
  carregarEventosDoDia(dataHoje);
});

let eventoAtual = null;

// üîπ Carregar monitores no select
function carregarMonitoresSelecionavel(monitorAtual) {
  fetch('/api/monitores')
    .then(res => res.json())
    .then(monitores => {
      const select = document.getElementById('selectMonitor');
      select.innerHTML = monitores.map(m =>
        `<option value="${m.id}" ${m.nome === monitorAtual ? 'selected' : ''}>${m.nome}</option>`
      ).join('');
    });
}

// üîπ Abrir modal com dados do evento
function abrirModal(id) {
  fetch('/api/agendamentos')
    .then(res => res.json())
    .then(eventos => {
      const ev = eventos.find(e => e.id == id);
      if (!ev) return;
      eventoAtual = ev;

      const dataFormatada = ev.start.split('T')[0].split('-').reverse().join('/');
      document.getElementById('modalTitulo').innerText = ev.title;
      document.getElementById('modalData').innerText = dataFormatada;
      document.getElementById('modalHora').innerText = ev.extendedProps.hora_festa || '-';
      document.getElementById('modalCliente').innerText = ev.title;
      document.getElementById('modalTelefone').innerText = ev.extendedProps.telefone || '-';
      document.getElementById('modalEndereco').innerText = ev.extendedProps.endereco || '-';
      document.getElementById('modalMonitor').innerText = ev.extendedProps.monitor || '-';
      document.getElementById('modalBrinquedos').innerText = (ev.extendedProps.brinquedos || []).join(', ');
      document.getElementById('modalValor').innerText = ev.extendedProps.valor_total.toFixed(2);
      document.getElementById('modalEvento').setAttribute('aria-hidden', 'false');

      // Carrega monitores dispon√≠veis
      carregarMonitoresSelecionavel(ev.extendedProps.monitor);
    });
}

// üíæ Salvar altera√ß√£o de monitor
document.getElementById('btnSalvarAlteracao').addEventListener('click', () => {
  if (!eventoAtual) return;
  const novoMonitorId = document.getElementById('selectMonitor').value;

  if (confirm("Deseja realmente alterar o monitor deste evento?")) {
    fetch(`/alterar_monitor/${eventoAtual.id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ monitor_id: novoMonitorId })
    })
      .then(res => res.json())
      .then(data => {
        alert(data.mensagem);
        window.location.reload();
      });
  }
});

// ‚úÖ Finalizar evento
document.getElementById('btnFinalizar').addEventListener('click', () => {
  if (!eventoAtual) return;
  if (confirm("Deseja finalizar este evento e adicion√°-lo ao financeiro?")) {
    fetch(`/finalizar_evento/${eventoAtual.id}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        alert(data.mensagem);
        window.location.reload();
      });
  }
});

// üóëÔ∏è Excluir evento
document.getElementById('btnExcluir').addEventListener('click', () => {
  if (!eventoAtual) return;
  if (confirm("Tem certeza que deseja excluir este agendamento?")) {
    fetch(`/excluir_evento/${eventoAtual.id}`, { method: 'DELETE' })
      .then(res => res.json())
      .then(data => {
        alert(data.mensagem);
        window.location.reload();
      });
  }
});
</script>